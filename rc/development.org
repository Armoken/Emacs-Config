#+TITLE: Development
#+OPTIONS: toc:nil num:nil ^:nil

Common settings for almost all development modes

* Configuration
** [[https://github.com/bbatsov/projectile][Project managment]]
   #+BEGIN_SRC emacs-lisp :noweb tangle
     (use-package projectile
         :ensure t
         :delight '(:eval (format "[P<%s>]" (projectile-project-name)))
         :bind (:map projectile-mode-map
                     ("<f9>"    . projectile-compile-project)
                     ("C-x p o" . projectile-switch-open-project)
                     ("C-x p s" . projectile-switch-project)
                     ("C-c p i" . projectile-invalidate-cache)
                     ("C-c p z" . projectile-cache-current-file))
         :init
         (progn
             <<helm-projectile-use-package>>

             (projectile-mode 1))
         :config
         (progn
             (setq projectile-completion-system 'helm)
             (setq projectile-switch-project-action 'helm-projectile)

             (setq projectile-project-root-files-top-down-recurring
                   (append
                    '("compile_commands.json"
                      ".cquery"
                      ".ccls")
                    projectile-project-root-files-top-down-recurring))))
   #+END_SRC

*** [[https://github.com/bbatsov/helm-projectile][Helm]]
     #+BEGIN_SRC emacs-lisp :tangle no :noweb-ref helm-projectile-use-package
       (use-package helm-projectile
           :ensure t
           :after projectile
           :bind (:map projectile-mode-map
                       ("C-c p s" . ayrc/helm-projectile-grep-or-rg)
                       ("C-c p h" . helm-projectile)
                       ("C-c p p" . helm-projectile-switch-project)
                       ("C-c p f" . helm-projectile-find-file)
                       ("C-c p F" . helm-projectile-find-file-in-known-projects)
                       ("C-c p g" . helm-projectile-find-file-dwim)
                       ("C-c p d" . helm-projectile-find-dir)
                       ("C-c p e" . helm-projectile-recentf)
                       ("C-c p a" . helm-projectile-find-other-file)
                       ("C-c p b" . helm-projectile-switch-to-buffer))
           :preface
           (progn
               (defun ayrc/helm-projectile-grep-or-rg ()
                   "Uses helm-projectile-grep, if ag doesn't present"
                   (interactive)
                   (if (executable-find "rg") (helm-projectile-rg)
                       (helm-projectile-grep)))))

     #+END_SRC

** Static code analysis
*** Flymake
    A universal on-the-fly syntax checker

    #+BEGIN_SRC emacs-lisp :noweb tangle
      (use-package flymake
          :diminish flymake-mode "[FM]"
          :commands (flymake-mode)
          :init
          (progn
              <<helm-flymake-use-package>>))
    #+END_SRC

**** [[https://github.com/tam17aki/helm-flymake][Helm]]
     #+BEGIN_SRC emacs-lisp :tangle no :noweb-ref helm-flymake-use-package
       (use-package helm-flymake
           :ensure t
           :bind (:map flymake-mode-map
                       ("C-c h f" . helm-flymake))
           :commands (helm-flymake))
     #+END_SRC

*** [[http://www.flycheck.org][Flycheck]]
    On-the-fly syntax checking

    #+BEGIN_SRC emacs-lisp :noweb tangle
      (use-package flycheck
          :ensure t
          :diminish flycheck-mode "[FC]"
          :commands (flycheck-mode)
          :hook (flycheck-mode . ayrc/flycheck-hook)
          :init
          (progn
              <<helm-flycheck-use-package>>)
          :preface
          (progn
              <<flycheck-hook>>))
    #+END_SRC

**** [[https://github.com/yasuyk/helm-flycheck][Helm]]
     #+BEGIN_SRC emacs-lisp :tangle no :noweb-ref helm-flycheck-use-package
       (use-package helm-flycheck
           :ensure t
           :after flycheck
           :bind (:map flycheck-mode-map
                       ("C-c h f" . helm-flycheck))
           :commands (helm-flycheck))
     #+END_SRC

**** Hook
     #+BEGIN_SRC emacs-lisp :tangle no :noweb-ref flycheck-hook
       (defun ayrc/flycheck-hook ()
           (flymake-mode -1)

           (setq flycheck-checker-error-threshold 700)
           (setq flycheck-standard-error-navigation nil)
           (setq flycheck-idle-change-delay 0)
           (setq flycheck-check-syntax-automatically '(save mode-enabled)))
     #+END_SRC

** Autocompletion
*** Semantic
    #+BEGIN_SRC emacs-lisp
      (use-package semantic
          :diminish semantic-mode "[S]"
          :commands (semantic-mode))
    #+END_SRC

*** [[http://company-mode.github.io/][Company]]
    #+BEGIN_SRC emacs-lisp :noweb tangle
      (use-package company
          :ensure t
          :diminish company-mode
          :bind
          (:map company-active-map
                ("<tab>" . company-complete-selection))
          :hook (company-mode . ayrc/company-hook)
          :init
          (progn
              <<company-box-use-package>>
              <<company-flx-use-package>>
              <<company-quickhelp-use-package>>)
          :preface
          (progn
              <<company-hook>>))
    #+END_SRC

**** [[https://www.github.com/expez/company-quickhelp][Documentation]]
    #+BEGIN_SRC emacs-lisp :tangle no :noweb-ref company-quickhelp-use-package
      (use-package company-quickhelp
          :ensure t
          :after company
          :hook (company-mode . company-quickhelp-mode)
          :bind (:map company-active-map
                      ("M-h" . #'company-quickhelp-manual-begin)))
    #+END_SRC

**** [[https://github.com/PythonNut/company-flx][Fuzzy matching]]
     #+BEGIN_SRC emacs-lisp :tangle no :noweb-ref company-flx-use-package
       (use-package company-flx
           :ensure t
           :after company
           :hook (company-mode . company-flx-mode))
     #+END_SRC

**** [[https://github.com/sebastiencs/company-box][Icons]]
    #+BEGIN_SRC emacs-lisp :tangle no :noweb-ref company-box-use-package
      (use-package company-box
          :ensure t
          :disabled
          :after company
          :hook (company-mode . company-box-mode)
          :config
          (progn
              (setq company-box-icons-alist company-box-icons-all-the-icons)))
     #+END_SRC

**** Hook
    #+BEGIN_SRC emacs-lisp :tangle no :noweb-ref company-hook
      (defun ayrc/company-hook ()
          (setq company-tooltip-align-annotations t

                ;; Easy navigation to candidates with M-<n>
                company-idle-delay                0.0

                company-show-numbers              t
                company-minimum-prefix-length     1)

          (setq company-backends
                ;; files & directory && keywords
                '((company-files        company-keywords)
                  ;; abbreviations && dynamic abbreviat
                  (company-abbrev     company-dabbrev))))
    #+END_SRC

** Folding
   #+BEGIN_SRC emacs-lisp
     (use-package hideshow
         :diminish hs-minor-mode
         :commands (hs-minor-mode)
         :bind
         (:map hs-minor-mode-map
               ("C-c f TAB" . hs-toggle-hiding)
               ("C-c f h"   . hs-hide-all)
               ("C-c f s"   . hs-show-all))
         :init
         (progn
             ;; For yaml mode and others
             (defun ayrc/indenation-toggle-fold ()
                 "Toggle fold all lines larger than indentation on current line"
                 (interactive)
                 (let ((col 1))
                     (save-excursion
                         (back-to-indentation)
                         (setq col (+ 1 (current-column)))
                         (set-selective-display
                          (if selective-display nil (or col 1)))))))
         :config
         (progn
             (add-to-list 'hs-special-modes-alist
                          (list 'nxml-mode
                                "<!--\\|<[^/>]*[^/]>"
                                "-->\\|</[^/>]*[^/]>"
                                "<!--"
                                'nxml-forward-element
                                nil))))
   #+END_SRC
** [[http://github.com/joaotavora/yasnippet][Snippets]]
   #+BEGIN_SRC emacs-lisp :noweb tangle
     (use-package yasnippet
         :ensure t
         :diminish yas-minor-mode
         :init
         (progn
             <<snippets-collection>>)
         :config
         (progn
             (setq yas-snippet-dirs
                   (list
                    yasnippet-snippets-dir
                    (ayrc/expand-config-path "./personal-snippets") ;; Personal snippets
                    ))
             (yas-reload-all)))
   #+END_SRC

*** [[https://github.com/AndreaCrotti/yasnippet-snippets][Ready snippets collection]]
    A collection of yasnippet snippets for many languages

    #+BEGIN_SRC emacs-lisp :tangle no :noweb-ref snippets-collection
      (use-package yasnippet-snippets
          :ensure t
          :after yasnippet)
    #+END_SRC

** Indents
   #+BEGIN_SRC emacs-lisp
     (setq-default tab-width 4)
     (setq-default pc-basic-offset 4)
     (setq-default standart-indent 4)
     (setq-default indent-tabs-mode nil)
   #+END_SRC

*** [[https://github.com/Malabarba/aggressive-indent-mode][Aggressive Indent]]
    Emacs minor mode that keeps your code always indented.
    More reliable than electric-indent-mode.

    #+BEGIN_SRC emacs-lisp :noweb tangle
      (use-package aggressive-indent
          :ensure t
          :commands (aggressive-indent-mode)
          :hook (aggressive-indent-mode . ayrc/aggressive-indent-hook)
          :diminish aggressive-indent-mode "[a]"
          :preface
          (progn
              <<aggressive-indent-hook>>))
    #+END_SRC

**** Hook
     #+BEGIN_SRC emacs-lisp :tangle no :noweb-ref aggressive-indent-hook
       (defun ayrc/aggressive-indent-hook ()
           (electric-indent-local-mode -1))
     #+END_SRC

** Highlighting
*** Syntax
    #+BEGIN_SRC emacs-lisp
      (use-package font-lock
        :config
        (progn
          (setq font-lock-maximum-decoration t)))
    #+END_SRC

*** [[https://github.com/antonj/Highlight-Indentation-for-Emacs][Indentation]]
    Minor modes for highlighting indentation

    #+BEGIN_SRC emacs-lisp
      (use-package highlight-indentation
        :ensure t
        :diminish "[hi]"
        :commands (highlight-indentation-mode))
    #+END_SRC

** [[https://github.com/editorconfig/editorconfig-emacs][EditorConfig]]
   #+BEGIN_SRC emacs-lisp
     (use-package editorconfig
       :ensure t
       :diminish "[ec]"
       :config
       (progn
         (editorconfig-mode)))
   #+END_SRC

** [[https://github.com/magnars/expand-region.el][Expand region]]                                  :global_hotkeys:
   #+BEGIN_SRC emacs-lisp
     (use-package expand-region
       :ensure t
       :commands (er/expand-region)
       :bind ("C-=" . er/expand-region))
   #+END_SRC

** Eldoc
   #+BEGIN_SRC emacs-lisp
     (use-package eldoc
         :diminish eldoc-mode
         :init
         (progn
             (global-eldoc-mode -1)))
   #+END_SRC

** [[https://github.com/leoliu/ggtags][GTags]]
   Emacs frontend to GNU Global source code tagging system

   #+NAME: gtags-system-prerequisites
   #+CAPTION: System prerequisites for GTags
   - [[https://www.gnu.org/software/global/][GNU Global]] :: intall it and put [[file:~/.emacs.d/other/etc/gtags.conf][gtags configuration]] into HOME/.globalrc
                   or gtags.conf into project root

   #+BEGIN_SRC emacs-lisp :noweb tangle
     (use-package ggtags
         :ensure t
         :diminish ggtags-mode "[G]"
         :commands (ggtags-mode)
         :init
         (progn
             <<helm-gtags-use-package>>)
         :config
         (progn
             (setq ggtags-update-on-save nil)
             (setq ggtags-use-idutils t)
             (setq ggtags-sort-by-nearness t)
             (unbind-key "M-<" ggtags-mode-map)
             (unbind-key "M->" ggtags-mode-map)))
   #+END_SRC

*** [[https://github.com/syohex/emacs-helm-gtags][Helm]]
    #+BEGIN_SRC emacs-lisp :tangle no :noweb-ref helm-gtags-use-package
      (use-package helm-gtags
          :ensure t
          :after ggtags
          :commands (helm-gtags-select helm-gtags-find-tag)
          :config
          (progn
              (setq helm-gtags-fuzzy-match t)
              (setq helm-gtags-preselect t)
              (setq helm-gtags-prefix-key "\C-cg")
              (setq helm-gtags-path-style 'relative)

              (define-key helm-gtags-mode-map (kbd "M-.") 'helm-gtags-dwim)
              (define-key helm-gtags-mode-map (kbd "M-,") 'helm-gtags-pop-stack)))
    #+END_SRC

** [[https://github.com/emacs-lsp/lsp-mode][LSP]]
   Emacs client/library for the Language Server Protocol

   #+BEGIN_SRC emacs-lisp :noweb tangle
     (use-package lsp-mode
         :ensure t
         :diminish lsp-mode "[L]"
         :commands (lsp-mode lsp-deffered lsp-rename)
         :hook (lsp-mode . ayrc/lsp-hook)
         :init
         (progn
             <<company-lsp-use-package>>
             <<lsp-ui-use-package>>
             <<helm-lsp-use-package>>)
         :config
         (progn
             <<redefined--lsp-auto-configure>>
             <<lsp-hook>>))
   #+END_SRC

*** Redefined lsp--auto-configure
    #+BEGIN_SRC emacs-lisp :tangle no :noweb-ref redefined--lsp-auto-configure
      (defun lsp--auto-configure ()
          "Autoconfigure `company', `flycheck', `lsp-ui',  if they are installed."

          (when (functionp 'lsp-ui-mode)
              (lsp-ui-mode))

          (cond
           ((or
             (and (eq lsp-diagnostic-package :auto)
                  (functionp 'flycheck-mode))
             (and (eq lsp-diagnostic-package :flycheck)
                  (or (functionp 'flycheck-mode)
                      (user-error
                       "lsp-diagnostic-package is set to :flycheck but flycheck is not installed?")))
             ;; legacy
             (null lsp-diagnostic-package))
            (lsp-flycheck-enable))
           ((and (not (version< emacs-version "26.1"))
                 (or (eq lsp-diagnostic-package :auto)
                     (eq lsp-diagnostic-package :flymake)
                     (eq lsp-diagnostic-package t)))
            (with-no-warnings
                (require 'flymake)
                (lsp--flymake-setup)))
           ((not (eq lsp-diagnostic-package :none))
            (lsp--warn "Unable to autoconfigure flycheck/flymake. The diagnostics won't be rendered.")))

          (cond
           ((and (functionp 'company-lsp)
                 (not lsp-prefer-capf))
            (progn
                (company-mode 1)
                (add-to-list 'company-backends '(company-lsp :with company-yasnippet))
                (setq-local company-backends (remove 'company-capf company-backends))))

           ((and (fboundp 'company-mode))
            (company-mode 1)
            (add-to-list 'company-backends 'company-capf))))
    #+END_SRC

*** Hook
    #+BEGIN_SRC emacs-lisp :tangle no :noweb-ref lsp-hook
      (defun ayrc/lsp-hook ()
          (setq lsp-prefer-flymake                         nil
                lsp-enable-folding                         t
                lsp-enable-snippet                         t
                lsp-vetur-completion-use-scaffold-snippets t
                lsp-enable-indentation                     t
                lsp-enable-file-watchers                   nil)

          (ayrc/local-set-keys '(("C-c r"   . lsp-rename)
                                 ("C-c C-r" . lsp-format-region)
                                 ("M-."     . lsp-ui-peek-find-definitions)
                                 ("M-,"     . xref-pop-marker-stack)
                                 ("M-?"     . lsp-ui-peek-find-references)
                                 ("C-M-."   . xref-find-apropos)))

          (flycheck-mode 1)

          (company-mode  1)
          (make-local-variable 'company-backends)

          (dap-mode      1))
    #+END_SRC

*** [[https://github.com/yyoncho/helm-lsp][Helm]]
    #+BEGIN_SRC emacs-lisp :tangle no :noweb-ref helm-lsp-use-package
      (use-package helm-lsp
          :ensure t
          :bind
          ((:map lsp-mode-map
                 ("C-c h w" . helm-lsp-workspace-symbol)))
          :commands (helm-lsp-workspace-symbol))
    #+END_SRC

*** [[https://github.com/tigersoldier/company-lsp][Company]]
    #+BEGIN_SRC emacs-lisp :tangle no :noweb-ref company-lsp-use-package
      (use-package company-lsp
          :ensure t
          :config
          (progn
              (setq
               company-lsp-enable-snippet      t
               company-transformers            nil
               company-lsp-async               t
               company-lsp-cache-candidates    nil

               company-lsp-enable-recompletion t)))
    #+END_SRC

*** [[https://github.com/emacs-lsp/lsp-ui][UI modules]]
    #+BEGIN_SRC emacs-lisp :tangle no :noweb-ref lsp-ui-use-package
      (use-package lsp-ui
          :ensure t
          :hook (lsp-mode . lsp-ui-mode)
          :config
          (progn
              (setq lsp-ui-peek-enable           nil
                    lsp-ui-sideline-enable       nil
                    lsp-ui-imenu-enable          t
                    lsp-ui-doc-enable            t
                    lsp-ui-flycheck-enable       t
                    lsp-ui-doc-include-signature nil
                    lsp-ui-sideline-show-symbol  nil)))
    #+END_SRC

** Xref
   Cross-referencing commands

   #+BEGIN_SRC emacs-lisp :noweb tangle
     (use-package xref
         :init
         (progn
             <<helm-xref-use-package>>))
   #+END_SRC

*** [[https://github.com/brotzeit/helm-xref][Helm]]
     #+BEGIN_SRC emacs-lisp  :tangle no :noweb-ref helm-xref-use-package
       (use-package helm-xref
           :ensure t
           :commands (helm-xref-show-xrefs)
           :config
           (progn
               (setq xref-show-xrefs-function 'helm-xref-show-xrefs)))
     #+END_SRC

** Debugging
*** [[http://github.com/realgud/realgud/][GUD]]
    #+BEGIN_SRC emacs-lisp
      (use-package realgud
          :ensure t
          :defer t)
    #+END_SRC

*** [[https://github.com/yyoncho/dap-mode][DAP]]
    Debug Adapter Protocol mode

    #+BEGIN_SRC emacs-lisp
      (use-package dap-mode
          :ensure t
          :diminish dap-mode "[D]"
          :hook (dap-mode . ayrc/dap-hook)
          :config
          (progn
              (defun ayrc/dap-hook ()
                  (setq dap-lldb-debug-program '("/usr/bin/lldb-vscode"))
                  (add-hook 'dap-stopped-hook
                            (lambda (arg) (call-interactively #'dap-hydra)))

                  ;; use tooltips for mouse hover
                  ;; if it is not enabled `dap-mode' will use the minibuffer.
                  (tooltip-mode 1)

                  (dap-ui-mode 1)

                  ;; enables mouse hover support
                  (dap-tooltip-mode 1)))
          :preface
          (progn
              (defun ayrc/dap-remove-nth-first-templates (count)
                  "For removing useless dap templates after loading of
                  language specific dap parts"
                  (setq dap-debug-template-configurations
                        (progn
                            (let ((rest-of-debug-templates
                                   (nthcdr
                                    count
                                    dap-debug-template-configurations)))
                                (if (listp rest-of-debug-templates)
                                        '()
                                    rest-of-debug-templates)))))))
    #+END_SRC

** Compilation
*** Press to compile                                                :global_hotkeys:
   #+BEGIN_SRC emacs-lisp
     (global-set-key (kbd "<f9>") 'compile)
   #+END_SRC

*** Errors switching                                                :global_hotkeys:
   #+BEGIN_SRC emacs-lisp
     (global-set-key (kbd "<f7>") 'next-error)
     (global-set-key (kbd "<f8>") 'previous-error)
   #+END_SRC
