#+TITLE: Lisp
#+OPTIONS: toc:nil num:nil ^:nil

Lisp family languages configuration.

* Configuration
   #+BEGIN_SRC emacs-lisp :noweb tangle
     (use-package lisp-mode
         :mode (("\\.el\\'"   .  emacs-lisp-mode)
                ("\\.rkt\\'"   . scheme-mode)
                ("\\.ss\\'"    . scheme-mode)
                ("\\.scm\\'"   . scheme-mode)
                ("\\.sch\\'"   . scheme-mode))
         :hook ((eval-expression-minibuffer-setup
                 . ayrc/eval-expression-minibuffer-setup-hook)
                (ielm-mode                        . ayrc/emacs-lisp-hook)
                (lisp-interaction-mode            . ayrc/emacs-lisp-hook)
                (emacs-lisp-mode                  . ayrc/emacs-lisp-hook)
                (scheme-mode                      . ayrc/scheme-hook))
         :init
         (progn
             <<rainbow-delimiters-use-package>>
             <<lisp-extra-font-lock-use-package>>
             <<elisp-slime-nav-use-package>>
             <<geiser-use-package>>

             ;; Mode with elisp is a first thind that user see
             <<lisp-hook>>
             <<emacs-lisp-hook>>))
   #+END_SRC

** Common configuration for all lisp dialects
*** [[https://github.com/Fanael/rainbow-delimiters][Highlights delimiters]]
    Such as parentheses, brackets or braces according to their depth

    #+NAME: rainbow-delimiters-use-package
    #+BEGIN_SRC emacs-lisp :tangle no :noweb yes
      (use-package rainbow-delimiters
          :ensure t)
    #+END_SRC

*** [[https://github.com/Lindydancer/lisp-extra-font-lock][Highlight bound variables and quoted expressions in lisp]]
    #+NAME: lisp-extra-font-lock-use-package
    #+BEGIN_SRC emacs-lisp :tangle no :noweb yes
      (use-package lisp-extra-font-lock
          :ensure t
          :diminish lisp-extra-font-lock-mode "[lefl]")
    #+END_SRC

*** Hook
    #+BEGIN_SRC emacs-lisp :tangle no :noweb-ref lisp-hook
      (defun ayrc/lisp-hook ()
          (display-line-numbers-mode 1)
          (visual-line-mode          1)
          ;; Very bad behaviour during work with long strings
          ;; (auto-fill-mode            -1)

          (ws-butler-mode            1)
          (smartparens-mode          1)
          (semantic-mode             1)
          (yas-minor-mode            1)

          (company-mode              1)
          (flycheck-mode             1)

          ;; eval-expression-minibuffer doesn't support this mode
          ;; (hs-minor-mode             -1)

          (aggressive-indent-mode    1)
          (add-hook 'after-change-major-mode-hook
                    (lambda() (electric-indent-mode -1)))

          (rainbow-delimiters-mode   1)
          (eldoc-mode                1)
          (lisp-extra-font-lock-mode 1)

          (prettify-symbols-mode     1)
          (setq prettify-symbols-unprettify-at-point 'right-edge)
          (push '(">=" . ?≥) prettify-symbols-alist)
          (push '("<=" . ?≤) prettify-symbols-alist)
          (push '("lambda"  . ?λ) prettify-symbols-alist)

          (setq lisp-body-indent 4)

          (add-hook 'write-contents-functions
                    'ayrc/cleanup-buffer-notabs nil t)
          )
    #+END_SRC

** Emacs Lisp
*** [[https://github.com/purcell/elisp-slime-nav][Navigation of source with M-. & M-,]]
    #+NAME: elisp-slime-nav-use-package
    #+BEGIN_SRC emacs-lisp :tangle no :noweb yes
      (use-package elisp-slime-nav
          :ensure t
          :diminish elisp-slime-nav-mode "[sn]")
    #+END_SRC

*** Hook
    #+BEGIN_SRC emacs-lisp :tangle no :noweb-ref emacs-lisp-hook
      (defun ayrc/emacs-lisp-hook ()
          (ayrc/lisp-hook)

          (hs-minor-mode t)
          (turn-on-elisp-slime-nav-mode)

          (add-to-list (make-local-variable 'company-backends)
                       '(company-elisp company-yasnippet)))

      (defun ayrc/eval-expression-minibuffer-setup-hook ()
          (ayrc/lisp-hook)

          (turn-on-elisp-slime-nav-mode)

          (add-to-list (make-local-variable 'company-backends)
                       '(company-elisp company-yasnippet)))
    #+END_SRC

** [[http://www.nongnu.org/geiser/][Scheme]]
   #+NAME: scheme-system-prerequisites
   #+CAPTION: System prerequisites for Scheme packages
   - [[https://github.com/racket/racket][Racket]] :: General purpose, multi-paradigm Lisp-Scheme programming
               language
   - [[https://www.gnu.org/software/guile/][Guile]] :: GNU Ubiquitous Intelligent Language for Extensions

   #+NAME: geiser-use-package
   #+BEGIN_SRC emacs-lisp :tangle no :noweb yes
     (use-package geiser
         :ensure t
         :preface
         (progn
             <<scheme-hook>>))
   #+END_SRC

*** Hook
    #+BEGIN_SRC emacs-lisp :tangle no :noweb-ref scheme-hook
      (defun ayrc/scheme-hook ()
          (ayrc/lisp-hook)

          (hs-minor-mode 1)
          (geiser-mode   1)
          (setq geiser-active-implementations '(racket guile))

          (make-local-variable 'company-backends)
          (add-to-list 'company-backends
                       '(company-capf company-dabbrev-code)))
    #+END_SRC
